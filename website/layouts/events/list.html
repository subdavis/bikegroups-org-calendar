{{ define "main" }}

{{/* ===== SCHEDULE VIEW ===== */}}
<section aria-label="Upcoming cycling events" class="-mt-2">
  {{ $prevDate := "" }}
  {{ range sort .Pages "Params.sort_key" "asc" }}
    {{ $startRaw := or .Params.start.dateTime .Params.start.date }}
    {{ $curDate := (time.AsTime $startRaw | time.Format "2006-01-02") }}

    {{/* Date header for new date groups */}}
    {{ if ne $curDate $prevDate }}
      <h3 class="flex items-center pt-3 pb-2" role="heading" aria-level="3">
        <span class="text-sm font-extrabold text-stone-700 tracking-wide" data-date="{{ $curDate }}">{{ time.AsTime $startRaw | time.Format "Monday, Jan 2" }}</span>
      </h3>
    {{ end }}
    {{ $prevDate = $curDate }}

    {{/* Schedule event row */}}
    <article class="{{ .Params.source_id }}">
      <a href="{{ .RelPermalink }}" class="flex items-stretch gap-3 no-underline text-inherit py-1 visited:text-inherit link-btn" aria-label="{{ .Params.summary }}">
        <div class="w-15 min-w-15 text-xs font-mono text-stone-700 pt-2 text-right shrink-0">
          {{ if .Params.start.dateTime }}
            {{ time.AsTime .Params.start.dateTime | time.Format "3:04 PM" }}
          {{ else }}
            All day
          {{ end }}
        </div>
        <div class="schedule-card flex flex-1 min-w-0 rounded-lg overflow-hidden ">
          <div class="schedule-card__accent-border w-1.5 min-w-1.5"></div>
          <div class="flex flex-col gap-0.5 py-1 px-3 min-w-0">
            <span class="font-semibold text-[0.95rem] whitespace-nowrap overflow-hidden text-ellipsis">{{ .Params.summary }}</span>
            {{ with .Params.location }}
              <span class="text-xs text-stone-600 whitespace-nowrap overflow-hidden text-ellipsis">{{ . }}</span>
            {{ end }}
            {{ with .Params.recurrence_label }}
              <span class="text-xs text-stone-600 font-semibold">{{ . }}</span>
            {{ end }}
          </div>
        </div>
      </a>
    </article>
  {{ end }}
</section>

<script>
(function() {
  var headers = document.querySelectorAll('[data-date]');
  if (!headers.length) return;
  var now = new Date();
  var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  for (var i = 0; i < 2 && i < headers.length; i++) {
    var parts = headers[i].dataset.date.split('-');
    var d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
    var days = Math.round((d - today) / 86400000);
    if (days === 0) headers[i].textContent = 'Today';
    else if (days === 1) headers[i].textContent = 'Tomorrow';
  }
})();
</script>

{{ end }}
